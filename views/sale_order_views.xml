<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Add action button to sale order form -->
    <record id="view_order_form_inherit_event_ticket_store" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.event.ticket.store</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form" />
        <field name="arch" type="xml">
            <xpath expr="//header/button[@name='action_quotation_send']" position="after">
                <button name="action_send_attendee_details_reminder"
                    type="object"
                    string="Send Attendee Details Reminder"
                    class="btn-primary"
                    invisible="state not in ('draft', 'sent')"
                    help="Send email reminder to customer to complete attendee details" />
            </xpath>
        </field>
    </record>

    <!-- Add smart button to show if attendee details are pending -->
    <record id="view_order_form_smart_button_inherit" model="ir.ui.view">
        <field name="name">sale.order.form.smart.button.inherit</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form" />
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_send_attendee_details_reminder"
                    type="object"
                    class="oe_stat_button"
                    icon="fa-exclamation-triangle"
                    invisible="not attendee_access_token or state not in ('draft', 'sent')"
                    help="Pending attendee details - click to send reminder">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text text-warning">Attendee Details</span>
                        <span class="o_stat_text text-warning">Pending</span>
                    </div>
                </button>
            </xpath>
        </field>
    </record>

    <!-- Server Action: Fix Legacy Pending Orders -->
    <record id="action_server_fix_legacy_pending_orders" model="ir.actions.server">
        <field name="name">Generate Tokens for Legacy Event Orders</field>
        <field name="model_id" ref="sale.model_sale_order" />
        <field name="binding_model_id" ref="sale.model_sale_order" />
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
            if records:
            action = records.action_fix_legacy_pending_orders()
        </field>
    </record>

    <!-- Menu item for admin utilities -->
    <menuitem id="menu_event_ticket_store_config"
        name="Event Ticket Store"
        parent="sale.menu_sale_config"
        sequence="100"
        groups="sales_team.group_sale_manager" />

    <record id="action_pending_event_orders" model="ir.actions.act_window">
        <field name="name">Pending Attendee Details</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('state', 'in', ['draft', 'sent']),
            ('order_line.product_id.service_tracking', '=', 'event'), ('attendee_access_token',
            '!=', False)]</field>
        <field name="context">{'search_default_pending_attendee_details': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No orders with pending attendee details
            </p>
            <p>
                Orders that have event tickets but haven't received attendee information yet will
                appear here.
            </p>
        </field>
    </record>

    <menuitem id="menu_pending_event_orders"
        name="Pending Attendee Details"
        parent="menu_event_ticket_store_config"
        action="action_pending_event_orders"
        sequence="10" />

</odoo>
